<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="utf-8">
<title>MPG123 Terminal</title>
<style>
#terminal {
  background: #000;
  color: #0f0;
  padding: 10px;
  height: 300px;
  overflow-y: auto;
  font-family: monospace;
  white-space: pre-wrap;
}

#downloads {
  margin-top: 20px;
  font-family: monospace;
}

#downloads ul {
  list-style: none;
  padding: 0;
}

#downloads li {
  padding: 6px;
  border-bottom: 1px solid #ddd;
  cursor: pointer;
}

#downloads li:hover {
  background: #eef;
}

.vid {
  color: #888;
  font-size: 12px;
}

.url {
  color: #06c;
  font-size: 12px;
  overflow-wrap: anywhere;
}
</style>
</head>
<body>

<h2>Player</h2>
<input id="yurl" placeholder="ex: https://www.youtube.com/watch?v=lsUppR9qyD0">
<button onclick="play()">Play</button>
<button onclick="stop()">Stop</button>

<pre id="terminal"></pre>

<div id="downloads">
  <h3>Downloaded Songs</h3>
  <ul id="downloadList"></ul>
</div>

<script>
let pollTimer = null;

/* =======================
 * Terminal polling
 * ======================= */
async function pollOutput() {
  try {
    const res = await fetch("/api/read_output");
    if (!res.ok) return;

    const data = await res.json();
    const terminal = document.getElementById("terminal");

    terminal.textContent = data.content;
    terminal.scrollTop = terminal.scrollHeight;
  } catch (e) {
    console.error(e);
  }
}

function startPolling() {
  if (pollTimer) return;
  pollTimer = setInterval(pollOutput, 5000);
}

/* =======================
 * Download list
 * ======================= */
async function loadDownloadList() {
  try {
    const res = await fetch("/api/list");
    if (!res.ok) return;

    const list = await res.json();
    const ul = document.getElementById("downloadList");
    ul.innerHTML = "";

    list.forEach(item => {
      const li = document.createElement("li");

      li.innerHTML = `
        <div><strong>${item.title || "(no title)"}</strong></div>
        <div class="vid">vid: ${item.vid}</div>
        <div class="url">${item.url}</div>
      `;

      // ✅ 點擊直接播放
      li.onclick = () => play(item.url);

      ul.appendChild(li);
    });
  } catch (e) {
    console.error(e);
  }
}

/* =======================
 * Stop
 * ======================= */
function stop() {
  fetch("/api/stop", {
    method: "POST"
  }).then(() => {
    pollOutput();   // 停止後立即刷新 terminal
  });
}

/* =======================
 * Controls
 * ======================= */
function play(url) {
  const yurl = url || document.getElementById("yurl").value;

  fetch("/api/play", {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({ yurl })
  });
  loadDownloadList();
}

/* =======================
 * Init
 * ======================= */
document.addEventListener("DOMContentLoaded", () => {
  startPolling();
  pollOutput();        // terminal 立刻更新
  loadDownloadList(); // 下載清單載入
});
</script>

</body>
</html>

